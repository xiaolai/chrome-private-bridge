name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: bun-darwin-arm64
            artifact: chrome-private-bridge-darwin-arm64
            os: macos-latest
          - target: bun-darwin-x64
            artifact: chrome-private-bridge-darwin-x64
            os: macos-latest
          - target: bun-linux-x64
            artifact: chrome-private-bridge-linux-x64
            os: ubuntu-latest
          - target: bun-windows-x64
            artifact: chrome-private-bridge-windows-x64
            os: ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install --frozen-lockfile

      - name: Build binary
        run: |
          OUTFILE="${{ matrix.artifact }}"
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            OUTFILE="${OUTFILE}.exe"
          fi
          bun build --compile --target=${{ matrix.target }} src/server.ts --outfile "$OUTFILE"

      # macOS: Import certificate and sign + notarize
      - name: Import Apple certificate
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | tr -d '"')
          rm certificate.p12

      - name: List imported identities
        if: runner.os == 'macOS'
        run: security find-identity -v -p codesigning build.keychain

      - name: Codesign binary
        if: runner.os == 'macOS'
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          codesign --force --timestamp \
            --sign "$APPLE_SIGNING_IDENTITY" \
            --options runtime \
            --keychain build.keychain \
            "${{ matrix.artifact }}"
          codesign -dv --verbose=2 "${{ matrix.artifact }}"

      - name: Notarize binary
        if: runner.os == 'macOS'
        continue-on-error: true
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          zip "${{ matrix.artifact }}.zip" "${{ matrix.artifact }}"
          xcrun notarytool submit "${{ matrix.artifact }}.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          rm "${{ matrix.artifact }}.zip"

      - name: Create tarball
        run: |
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}.exe
          else
            tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

  build-extension:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install --frozen-lockfile

      - name: Build extension
        run: bun extension/build.ts

      - name: Create zip
        run: cd extension/dist && zip -r ../../chrome-extension.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: chrome-extension.zip

  release:
    needs: [build, build-extension]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        working-directory: artifacts
        run: sha256sum *.tar.gz *.zip > checksums.txt

      - name: Show checksums
        run: cat artifacts/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/checksums.txt

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Compute SHA256s
        id: sha
        working-directory: artifacts
        run: |
          echo "darwin_arm64=$(sha256sum chrome-private-bridge-darwin-arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "darwin_x64=$(sha256sum chrome-private-bridge-darwin-x64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_x64=$(sha256sum chrome-private-bridge-linux-x64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew formula
        uses: actions/checkout@v4
        with:
          repository: xiaolai/homebrew-chrome-private-bridge
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Write formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p tap/Formula
          cat > tap/Formula/chrome-private-bridge.rb << 'FORMULA'
          class ChromePrivateBridge < Formula
            desc "MCP-native Chrome browser automation bridge"
            homepage "https://github.com/xiaolai/chrome-private-bridge"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/xiaolai/chrome-private-bridge/releases/download/vVERSION_PLACEHOLDER/chrome-private-bridge-darwin-arm64.tar.gz"
                sha256 "SHA_DARWIN_ARM64"
              else
                url "https://github.com/xiaolai/chrome-private-bridge/releases/download/vVERSION_PLACEHOLDER/chrome-private-bridge-darwin-x64.tar.gz"
                sha256 "SHA_DARWIN_X64"
              end
            end

            on_linux do
              url "https://github.com/xiaolai/chrome-private-bridge/releases/download/vVERSION_PLACEHOLDER/chrome-private-bridge-linux-x64.tar.gz"
              sha256 "SHA_LINUX_X64"
            end

            def install
              bin.install Dir["chrome-private-bridge*"].first => "chrome-private-bridge"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/chrome-private-bridge version")
            end
          end
          FORMULA

          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" tap/Formula/chrome-private-bridge.rb
          sed -i "s/SHA_DARWIN_ARM64/${{ steps.sha.outputs.darwin_arm64 }}/g" tap/Formula/chrome-private-bridge.rb
          sed -i "s/SHA_DARWIN_X64/${{ steps.sha.outputs.darwin_x64 }}/g" tap/Formula/chrome-private-bridge.rb
          sed -i "s/SHA_LINUX_X64/${{ steps.sha.outputs.linux_x64 }}/g" tap/Formula/chrome-private-bridge.rb

      - name: Push formula
        working-directory: tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/chrome-private-bridge.rb
          git commit -m "Update chrome-private-bridge to ${{ steps.version.outputs.version }}"
          git push
